App.Pages.Booking=function(){let e=$("#select-date"),t=$("#select-service"),a=$("#select-provider"),i=$("#select-timezone"),l=$("#first-name"),n=$("#last-name"),s=$("#email"),r=$("#phone-number"),o=$("#address"),d=$("#city"),c=$("#zip-code"),m=$("#notes"),p=$(".captcha-title"),v=$("#available-hours"),f=$("#book-appointment-submit"),u=$("#delete-personal-information"),g=$("#custom-field-1"),h=$("#custom-field-2"),b=$("#custom-field-3"),k=$("#custom-field-4"),D=$("#custom-field-5"),Y=window.tippy,U=window.moment,x=vars("manage_mode")||!1;function y(e,t){return e.isAfter(t)?-1:1}function C(e,t){let a=$(e);a.length&&a.val(App.Utils.Url.queryParam(t))}return document.addEventListener("DOMContentLoaded",function _(){if(Boolean(Number(vars("display_cookie_notice")))&&window?.cookieconsent){cookieconsent.initialise({palette:{popup:{background:"#ffffffbd",text:"#666666"},button:{background:"#429a82",text:"#ffffff"}},content:{message:lang("website_using_cookies_to_ensure_best_experience"),dismiss:"OK"}});let w=$(".cc-link");w.replaceWith($("<a/>",{"data-bs-toggle":"modal","data-bs-target":"#cookie-notice-modal",href:"#",class:"cc-link",text:w.text()}))}x=vars("manage_mode"),Y("[data-tippy-content]");let H;App.Utils.UI.initializeDatePicker(e,{inline:!0,minDate:U().subtract(1,"day").set({hours:23,minutes:59,seconds:59}).toDate(),maxDate:U().add(vars("future_booking_limit"),"days").toDate(),onChange(e){App.Http.Booking.getAvailableHours(U(e[0]).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame()},onMonthChange(i,l,n){e.parent().fadeTo(400,.3),H&&clearTimeout(H),H=setTimeout(()=>{let e=U(n.selectedDates[0]),i=U(n.currentYearElement.value+"-"+String(Number(n.monthsDropdownContainer.value)+1).padStart(2,"0")+"-01"),l=y(e,i);App.Http.Booking.getUnavailableDates(a.val(),t.val(),i.format("YYYY-MM-DD"),l)},500)},onYearChange(e,i,l){setTimeout(()=>{let e=U(l.selectedDates[0]),i=U(l.currentYearElement.value+"-"+(Number(l.monthsDropdownContainer.value)+1)+"-01"),n=y(e,i);App.Http.Booking.getUnavailableDates(a.val(),t.val(),i.format("YYYY-MM-DD"),n)},500)}}),App.Utils.UI.setDateTimePickerValue(e,new Date);let M=Intl.DateTimeFormat().resolvedOptions().timeZone,P=i.find(`option[value="${M}"]`).length>0;if(i.val(P?M:"UTC"),i.on("change",()=>{let t=App.Utils.UI.getDateTimePickerValue(e);t&&(App.Http.Booking.getAvailableHours(U(t).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame())}),a.on("change",a=>{let i=$(a.target),l=new Date,n=U(l);App.Utils.UI.setDateTimePickerValue(e,l),App.Http.Booking.getUnavailableDates(i.val(),t.val(),n.format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame()}),t.on("change",i=>{let l=$(i.target),n=t.val();a.empty(),a.append(new Option(lang("please_select"),"")),vars("available_providers").forEach(e=>{let t=e.services.filter(e=>Number(e)===Number(n)).length>0;t&&a.append(new Option(e.first_name+" "+e.last_name,e.id))}),a.find("option").length>1&&"1"===vars("display_any_provider")&&$(new Option(lang("any_provider"),"any-provider")).insertAfter(a.find("option:first")),App.Http.Booking.getUnavailableDates(a.val(),l.val(),U(App.Utils.UI.getDateTimePickerValue(e)).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame(),App.Pages.Booking.updateServiceDescription(n)}),$(".button-next").on("click",e=>{let t=$(e.currentTarget);if("1"===t.attr("data-step_index")&&!a.val())return;if("2"===t.attr("data-step_index")&&!$(".selected-hour").length){$("#select-hour-prompt").length||$("<div/>",{id:"select-hour-prompt",class:"text-danger mb-4",text:lang("appointment_hour_missing")}).prependTo("#available-hours");return}if("3"===t.attr("data-step_index")){if(!App.Pages.Booking.validateCustomerForm())return;App.Pages.Booking.updateConfirmFrame()}let i=parseInt(t.attr("data-step_index"))+1;t.parents().eq(1).fadeOut(()=>{$(".active-step").removeClass("active-step"),$("#step-"+i).addClass("active-step"),$("#wizard-frame-"+i).fadeIn()});let l=document.scrollingElement||document.body;window.innerHeight<l.scrollHeight&&(l.scrollTop=0)}),$(".button-back").on("click",e=>{let t=parseInt($(e.currentTarget).attr("data-step_index"))-1;$(e.currentTarget).parents().eq(1).fadeOut(()=>{$(".active-step").removeClass("active-step"),$("#step-"+t).addClass("active-step"),$("#wizard-frame-"+t).fadeIn()})}),v.on("click",".available-hour",e=>{v.find(".selected-hour").removeClass("selected-hour"),$(e.target).addClass("selected-hour"),App.Pages.Booking.updateConfirmFrame()}),x&&($("#cancel-appointment").on("click",()=>{let e=$("#cancel-appointment-form"),t,a=[{text:lang("close"),click(e,t){t.hide()}},{text:lang("confirm"),click(){if(""===t.val()){t.css("border","2px solid #DC3545");return}e.find("#hidden-cancellation-reason").val(t.val()),e.submit()}},];return App.Utils.Message.show(lang("cancel_appointment_title"),lang("write_appointment_removal_reason"),a),t=$("<textarea/>",{class:"form-control",id:"cancellation-reason",rows:"3",css:{width:"100%"}}).appendTo("#message-modal .modal-body"),!1}),u.on("click",()=>{let e=[{text:lang("cancel"),click(e,t){t.hide()}},{text:lang("delete"),click(){App.Http.Booking.deletePersonalInformation(vars("customer_token"))}},];App.Utils.Message.show(lang("delete_personal_information"),lang("delete_personal_information_prompt"),e)})),f.on("click",()=>{let e=$("#accept-to-terms-and-conditions");if(e.removeClass("is-invalid"),e.length&&!e.prop("checked")){e.addClass("is-invalid");return}let t=$("#accept-to-privacy-policy");if(t.removeClass("is-invalid"),t.length&&!t.prop("checked")){t.addClass("is-invalid");return}App.Http.Booking.registerAppointment()}),p.on("click","button",()=>{$(".captcha-image").attr("src",App.Utils.Url.siteUrl("captcha?"+Date.now()))}),e.on("mousedown",".ui-datepicker-calendar td",()=>{setTimeout(()=>{App.Http.Booking.applyPreviousUnavailableDates()},300)}),function e(){let t=$("#wizard-frame-3 .field-col:first"),a=t.find(".form-control"),i=$("#wizard-frame-3 .field-col:last"),l=i.find(".form-control");1===a.length&&l.length>1&&a.each((e,t)=>{$(t).parent().insertBefore(l.first().parent())}),1===l.length&&a.length>1&&l.each((e,t)=>{$(t).parent().insertAfter(a.last().parent())});let n=$(document).find("#wizard-frame-3 .field-col");n.each((e,t)=>{let a=$(t);a.find(".form-control").length||a.hide()})}(),x)(function p(v,f,u){try{t.val(v.id_services).trigger("change"),a.val(v.id_users_provider);let Y=U(v.start_datetime);App.Utils.UI.setDateTimePickerValue(e,Y.toDate()),App.Http.Booking.getAvailableHours(Y.format("YYYY-MM-DD")),n.val(u.last_name),l.val(u.first_name),s.val(u.email),r.val(u.phone_number),o.val(u.address),d.val(u.city),c.val(u.zip_code),u.timezone&&i.val(u.timezone);let x=null!==v.notes?v.notes:"";return m.val(x),g.val(u.custom_field_1),h.val(u.custom_field_2),b.val(u.custom_field_3),k.val(u.custom_field_4),D.val(u.custom_field_5),App.Pages.Booking.updateConfirmFrame(),!0}catch(y){return!1}})(vars("appointment_data"),vars("provider_data"),vars("customer_data")),$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn();else{let z=App.Utils.Url.queryParam("service");z&&t.find('option[value="'+z+'"]').length>0&&t.val(z),t.trigger("change");let B=App.Utils.Url.queryParam("provider");if(B&&0===a.find('option[value="'+B+'"]').length)for(let T in vars("available_providers")){let F=vars("available_providers")[T];F.id===B&&F.services.length>0&&t.val(F.services[0]).trigger("change")}B&&a.find('option[value="'+B+'"]').length>0&&a.val(B).trigger("change"),z&&B||1===vars("available_services").length&&1===vars("available_providers").length?(z||t.val(vars("available_services")[0].id).trigger("change"),B||a.val(vars("available_providers")[0].id).trigger("change"),$(".active-step").removeClass("active-step"),$("#step-2").addClass("active-step"),$("#wizard-frame-1").hide(),$("#wizard-frame-2").fadeIn(),t.closest(".wizard-frame").find(".button-next").trigger("click"),$(document).find(".book-step:first").hide(),$(document).find(".button-back:first").css("visibility","hidden"),$(document).find(".book-step:not(:first)").each((e,t)=>$(t).find("strong").text(e+1))):$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn(),C("#first-name","first_name"),C("#last-name","last_name"),C("#email","email"),C("#phone-number","phone"),C("#address","address"),C("#city","city"),C("#zip-code","zip")}}),{manageMode:x,updateConfirmFrame:function p(){let f=t.find("option:selected").text();$(".display-selected-service").text(f).removeClass("invisible");let u=a.find("option:selected").text();if($(".display-selected-provider").text(u).removeClass("invisible"),!v.find(".selected-hour").text())return;let Y=t.val(),y=vars("available_services").find(e=>Number(e.id)===Number(Y));if(!y)return;let C=App.Utils.UI.getDateTimePickerValue(e),_=U(C),w=_.format("YYYY-MM-DD"),H=v.find(".selected-hour").text(),M=`${w} ${H}`,P;C&&(P=App.Utils.Date.format(M,vars("date_format"),vars("time_format"),!0)),i.find("option:selected").text(),$("#appointment-details").html(`
            <div class="card" width: 24rem;>
                <div class="card-body">
                    <h2 class="card-titulo">Cita</h2>
                    <div class="mb-2 fw-bold fs-3">
                        <span>Servicio: </span>${f}
                    </div>
                    <div class="mb-2 fw-bold text-muted">
                        <span>Estilista: </span>${u}
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-calendar-day me-2"></i>
                        <span>Fecha: </span>${P}
                    </div>
                    <div class="mb-2 ${Number(y.price)?"":"d-none"}">
                        <i class="fas fa-cash-register me-2"></i>
                        <span>Precio: </span>${Number(y.price).toLocaleString("es-ES",{minimumFractionDigits:0,maximumFractionDigits:2}).replace(",",".")} ${y.currency}
                    </div>
                </div>
            </div>
        `);let z=App.Utils.String.escapeHtml(l.val()),B=App.Utils.String.escapeHtml(n.val()),T=`${z} ${B}`.trim(),F=App.Utils.String.escapeHtml(s.val()),I=App.Utils.String.escapeHtml(r.val()),S=App.Utils.String.escapeHtml(o.val()),V=App.Utils.String.escapeHtml(d.val()),A=App.Utils.String.escapeHtml(c.val()),q=[];V&&q.push(V),A&&q.push(A),$("#customer-details").html(`
            <div class="card" width: 24rem;>
                <div class="card-body">
                    <h2 class="card-titulo">informaci\xf3n de contacto</h2>
                        <div class="mb-2 fw-bold text-muted" ${T?"":"hidden"}>
                           <span>Nombre: </span> ${T}
                        </div>
                        <div class="mb-2" ${F?"":"hidden"}>
                           <span>Correo: </span>  ${F}
                        </div>
                        <div class="mb-2" ${F?"":"hidden"}>
                           <span>Numero: </span>  ${I}
                        </div>
                        <div class="mb-2" ${S?"":"hidden"}>
                            ${S}
                        </div>
                        <div class="mb-2" ${q.length?"":"hidden"}>
                            ${q.join(", ")}
                        </div>
                </div>
            </div>
        `);let E={};E.customer={last_name:n.val(),first_name:l.val(),email:s.val(),phone_number:r.val(),address:o.val(),city:d.val(),zip_code:c.val(),timezone:i.val(),custom_field_1:g.val(),custom_field_2:h.val(),custom_field_3:b.val(),custom_field_4:k.val(),custom_field_5:D.val()},E.appointment={start_datetime:U(App.Utils.UI.getDateTimePickerValue(e)).format("YYYY-MM-DD")+" "+U($(".selected-hour").data("value"),"HH:mm").format("HH:mm")+":00",end_datetime:function a(){let i=t.val(),l=vars("available_services").find(e=>Number(e.id)===Number(i)),n=U(App.Utils.UI.getDateTimePickerValue(e)).format("YYYY-MM-DD"),s=$(".selected-hour").data("value"),r=U(n+" "+s),o;return(o=l.duration&&r?r.clone().add({minutes:parseInt(l.duration)}):U()).format("YYYY-MM-DD HH:mm:ss")}(),notes:m.val(),is_unavailability:!1,id_users_provider:a.val(),id_services:t.val()},E.manage_mode=Number(x),x&&(E.appointment.id=vars("appointment_data").id,E.customer.id=vars("customer_data").id),$('input[name="post_data"]').val(JSON.stringify(E))},updateServiceDescription:function e(t){let a=$("#service-description");a.empty();let i=vars("available_services").find(e=>Number(e.id)===Number(t));if(!i)return;let l=[];if(i.duration&&l.push(`${lang("duration")}: ${i.duration} ${lang("minutes")}`),Number(i.price)>0&&l.push(`${lang("price")}: ${Number(i.price).toFixed(2)} ${i.currency}`),i.location&&l.push(`${lang("location")}: ${i.location}`),l.length&&$(`
                <div class="mb-2 fst-italic">
                    ${l.join(", ")}
                </div>
            `).appendTo(a),i.description?.length){let n=App.Utils.String.escapeHtml(i.description),s=n.replaceAll("\n","<br/>");$(`
                <div class="text-muted">
                    ${s}
                </div>
            `).appendTo(a)}},validateCustomerForm:function e(){$("#wizard-frame-3 .is-invalid").removeClass("is-invalid"),$("#wizard-frame-3 label.text-danger").removeClass("text-danger");let t=!1;if($(".required").each((e,a)=>{$(a).val()||($(a).addClass("is-invalid"),t=!0)}),t)return $("#form-message").text(lang("fields_are_required")),!1;if(s.val()&&!App.Utils.Validation.email(s.val()))return s.addClass("is-invalid"),$("#form-message").text(lang("invalid_email")),!1;let a=r.val();return!a||!!App.Utils.Validation.phone(a)||(r.addClass("is-invalid"),$("#form-message").text(lang("invalid_phone")),!1)}}}();